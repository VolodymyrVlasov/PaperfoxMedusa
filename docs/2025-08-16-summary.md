# PaperfoxMedusa — Tech Note / Changes since 2025-08-13

## Коротко

- Перехід на **PM2 deploy** (pull з GitHub, post-deploy build, рестарт сервісу).
- Винесена інфраструктура у **`infra/`** (Nginx, PM2).
- Додано **gulp-пайплайн** для збирання фронтової статики та доставки на сервер.
- Оновлені **CORS**/Headers і **Nginx** для `api.paperfox.top`, `admin.paperfox.top`, `paperfox.top`.
- Налаштовано **локальний файловий провайдер** Medusa (`@medusajs/medusa/file-local`) з публічною роздачею `/static/`.
- Уточнено структуру директорій на сервері: **сайт** віддається з `/var/www/paperfox.top`, **API** через PM2 на `:9000` за reverse-proxy.

---

## Що змінено

### Backend (Medusa)

- `medusa-config.js` переведений на `defineConfig` та `loadEnv`.
- Додані CORS-налаштування через `.env`:
  - `STORE_CORS`, `ADMIN_CORS`, `AUTH_CORS` (fallback на `ADMIN_CORS`).
- Параметри підключення PostgreSQL: `databaseDriverOptions: { ssl: false }`, підтримка `PGSSLMODE=disable`.
- Підключено модуль файлів:
  - `@medusajs/medusa/file` + `@medusajs/medusa/file-local`
  - `upload_dir: "static"`
  - `backend_url: "https://api.paperfox.top/static"`

### Frontend Static (site)

- Новий каталог вихідників: `apps/site-src/`.
- Gulp-таски:
  - `buildPages()` — HTML з `gulp-file-include`.
  - `buildStyles()` — CSS з плейсхолдерами.
  - `buildAssets()` — копіювання `/static` + конвертація у WebP.
  - `buildPagesScripts()` — копіювання сторінкових \*.js.
- Деплой статики керується через gulp (`deployCode`), таргети:
  - **LOCAL_SERVER** (локально).
  - **PROD_SERVER** (`/var/www/paperfox.top`).

### PM2 / Deploy

- Новий файл `infra/pm2/ecosystem.config.cjs`:
  - **apps**: процес `medusa-api`.
  - **deploy.production**:  
    repo, host, user, path, `post-deploy` hook з `npm ci && npm run build && npm run buildStaticSite && pm2 startOrReload ...`.
- Структура PM2: `/home/deploy/apps/medusa-paperfox/current`.

### Nginx

- Конфіги у `infra/nginx/`:
  - `paperfox.top.conf` — сайт, root `/var/www/paperfox.top`.
  - `admin.paperfox.top.conf` — редирект `/` → `/app/`, SPA-роутинг.
  - `api.paperfox.top.conf` — reverse-proxy на `127.0.0.1:9000`, CORS.

---

## Файли / каталоги, що додані/змінені

- `medusa-config.js` — оновлено.
- `.env` — оновлено.
- `infra/pm2/ecosystem.config.cjs` — новий.
- `infra/nginx/*.conf` — нові.
- `apps/site-src/**` — нові.
- `scripts/gulp-scripts/**` — нові.
- `gulpfile.js` — оновлено.

---

## Відомі нюанси / ризики

- **cwebp/libpng** потрібні на сервері.
- `.env` має бути в актуальному стані на сервері.
- Коренева папка сайту `/var/www/paperfox.top`.
- Адмінка працює як SPA на `/app/`.
- CORS виставляються точно під домени.

---

## Перевірка після деплою

1. **PM2**
   ```
   pm2 ls
   pm2 logs medusa-api --lines 200
   curl -I http://127.0.0.1:9000/health
   ```

## API CORS

```
curl -i -X OPTIONS https://api.paperfox.top/auth/user/emailpass \
  -H 'Origin: https://admin.paperfox.top' \
  -H 'Access-Control-Request-Method: POST' \
  -H 'Access-Control-Request-Headers: Content-Type'
```

## Адмінка

```
curl -I https://admin.paperfox.top/
curl -I https://admin.paperfox.top/app/
```

## Сайт
```
curl -I https://paperfox.top/
```

# Висновок
- Інфраструктура для деплою оновлена та узгоджена: сайт і статика працюють через gulp+nginx.
- Однак бекенд Medusa не запускається через конфлікт CommonJS/ESM (Error [ERR_REQUIRE_ESM]: Must use import to load ES Module).
- Це потребує додаткового доопрацювання: або зміни у package.json ("type": "commonjs"), або використання import() у місцях завантаження .ts файлів.
- До стабільного запуску API поки що не дійшли.